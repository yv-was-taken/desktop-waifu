#!/usr/bin/make -f

export DH_VERBOSE = 1
export CARGO_HOME = $(CURDIR)/debian/cargo_home
export RUSTUP_TOOLCHAIN = stable

%:
	dh $@

override_dh_auto_configure:
	# Install bun if not available
	if ! command -v bun >/dev/null 2>&1; then \
		curl -fsSL https://bun.sh/install | bash; \
		export PATH="$$HOME/.bun/bin:$$PATH"; \
	fi

override_dh_auto_build:
	# Build frontend
	bun install --frozen-lockfile
	bun run build:web
	# Build overlay binary
	cargo build --release --manifest-path desktop-waifu-overlay/Cargo.toml
	# Build Tauri launcher
	cargo build --release --manifest-path src-tauri/Cargo.toml

override_dh_auto_install:
	# Install Tauri launcher as main entry point
	install -Dm755 src-tauri/target/release/desktop-waifu-tauri debian/desktop-waifu/usr/bin/desktop-waifu
	# Install overlay binary (Tauri looks for this by name)
	install -Dm755 desktop-waifu-overlay/target/release/desktop-waifu-overlay debian/desktop-waifu/usr/bin/desktop-waifu-overlay
	# Install frontend assets
	install -dm755 debian/desktop-waifu/usr/share/desktop-waifu
	cp -r dist/* debian/desktop-waifu/usr/share/desktop-waifu/
	# Install desktop entry
	install -Dm644 packaging/desktop-waifu.desktop debian/desktop-waifu/usr/share/applications/desktop-waifu.desktop

override_dh_shlibdeps:
	dh_shlibdeps --dpkg-shlibdeps-params=--ignore-missing-info

override_dh_auto_clean:
	cargo clean --manifest-path desktop-waifu-overlay/Cargo.toml || true
	cargo clean --manifest-path src-tauri/Cargo.toml || true
	rm -rf node_modules dist
